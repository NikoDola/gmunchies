"use client";

import "./Admin.css";
import Link from "next/link";
import { useEffect, useState } from "react";
import type { CmsContent } from "@/lib/content";
import { FiArrowLeft } from "react-icons/fi";
import { signIn, signOut, useSession } from "next-auth/react";

type EditorMode = "locations" | "services";

function deepClone<T>(value: T): T {
  // structuredClone isn't available in older iOS Safari
  // eslint-disable-next-line @typescript-eslint/no-explicit-any
  const sc = (globalThis as any).structuredClone as undefined | ((v: unknown) => unknown);
  if (sc) return sc(value) as T;
  return JSON.parse(JSON.stringify(value)) as T;
}

export default function Dashboard() {
  const { data: session, status: sessionStatus } = useSession();
  const [cms, setCms] = useState<CmsContent | null>(null);
  const [status, setStatus] = useState<string | null>(null);
  const [popup, setPopup] = useState<null | { title: string; body: string; kind: "success" | "error" | "info" }>(
    null,
  );
  const [loading, setLoading] = useState(false);
  const [mode, setMode] = useState<EditorMode>("locations");
  const [mediaOpen, setMediaOpen] = useState(false);
  const [media, setMedia] = useState<string[]>([]);
  const [mediaTarget, setMediaTarget] = useState<
    null | { type: "location" | "service"; slug: string; blockIdx?: number; field: "heroImageSrc" | "imageSrc" | "iconSrc" | "blockIconSrc" }
  >(null);

  async function load() {
    if (loading) return;
    setLoading(true);
    setStatus("loading...");
    try {
      const res = await fetch("/api/admin/content", {
        method: "GET",
        credentials: "include",
      });
      const json = await res.json();
      if (!res.ok) {
        const details = json.details ? `\n${JSON.stringify(json.details, null, 2)}` : "";
        setStatus(`error: ${json.error ?? "load failed"}${details}`);
        return;
      }
      setCms(json.data as CmsContent);
      setStatus(json.warning ? `loaded (warning: ${json.warning})` : "loaded");
    } catch {
      setStatus("network error");
    } finally {
      setLoading(false);
    }
  }

  async function save() {
    if (!cms || loading) return;
    setLoading(true);
    setStatus("saving...");
    try {
      const res = await fetch("/api/admin/content", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(cms),
      });
      const json = await res.json();
      if (!res.ok) {
        const details = json.details
          ? `\n${JSON.stringify(json.details, null, 2)}`
          : json.issues
            ? `\n${JSON.stringify(json.issues, null, 2)}`
            : "";
        const msg = `Error while saving.\n\n${json.error ?? "save failed"}${details}\n\nNeed help? Email niko: nikodola@gmail.com`;
        setStatus(`error: ${json.error ?? "save failed"}${details}`);
        setPopup({ title: "Save failed", body: msg, kind: "error" });
        return;
      }
      if (json.committed === false) {
        const msg = `Saved locally only.\n\n${json.warning ?? "GitHub sync disabled"}`;
        setStatus(`saved locally only (warning: ${json.warning ?? "GitHub sync disabled"})`);
        setPopup({ title: "Saved locally", body: msg, kind: "info" });
        return;
      }

      const sha = json.commit?.sha as string | undefined;
      const url = json.commit?.url as string | undefined;
      const msg = url
        ? `Saved to GitHub.\n\nCommit: ${sha?.slice(0, 7) ?? "unknown"}\n${url}\n\nVercel should auto-deploy shortly.`
        : "Saved to GitHub.\n\nVercel should auto-deploy shortly.";
      setStatus(url ? `saved to GitHub (${sha?.slice(0, 7) ?? "unknown"}): ${url}` : "saved to GitHub");
      setPopup({ title: "Saved", body: msg, kind: "success" });
    } catch {
      setStatus("network error");
      setPopup({
        title: "Save failed",
        body: "Network error while saving.\n\nNeed help? Email niko: nikodola@gmail.com",
        kind: "error",
      });
    } finally {
      setLoading(false);
    }
  }

  useEffect(() => {
    if (!popup) return;
    const onKeyDown = (e: KeyboardEvent) => {
      if (e.key === "Escape") setPopup(null);
    };
    window.addEventListener("keydown", onKeyDown);
    return () => window.removeEventListener("keydown", onKeyDown);
  }, [popup]);

  useEffect(() => {
    if (sessionStatus !== "authenticated") return;
    if (cms) return;
    void load();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [sessionStatus]);

  async function uploadFile(file: File): Promise<string | null> {
    try {
      const form = new FormData();
      form.append("file", file);
      const res = await fetch("/api/admin/upload", {
        method: "POST",
        credentials: "include",
        body: form,
      });
      const json = await res.json();
      if (!res.ok) {
        const details = json.details ? `\n${JSON.stringify(json.details, null, 2)}` : "";
        setStatus(`error: ${json.error ?? "upload failed"}${details}`);
        return null;
      }
      return json.path as string;
    } catch {
      setStatus("error: upload network error");
      return null;
    }
  }

  async function openMediaPicker(target: NonNullable<typeof mediaTarget>) {
    setMediaTarget(target);
    setMediaOpen(true);
    try {
      const res = await fetch("/api/admin/media", { credentials: "include" });
      const json = await res.json();
      if (!res.ok) {
        setStatus(`error: ${json.error ?? "failed to load media"}`);
        setMedia([]);
        return;
      }
      setMedia(json.items as string[]);
    } catch {
      setStatus("error: failed to load media");
      setMedia([]);
    }
  }

  function setImageFromPicker(path: string) {
    if (!cms || !mediaTarget) return;

    setCms((prev) => {
      if (!prev) return prev;
      const next: CmsContent = deepClone(prev);
      if (mediaTarget.type === "location") {
        const loc = next.locations.find((l) => l.slug === mediaTarget.slug);
        if (!loc) return next;
        if (mediaTarget.field === "heroImageSrc") {
          loc.heroImageSrc = path;
        } else if (mediaTarget.field === "blockIconSrc") {
          const idx = mediaTarget.blockIdx ?? -1;
          if (idx >= 0 && loc.blocks[idx]) (loc.blocks[idx] as any).iconSrc = path;
        } else if (mediaTarget.field === "imageSrc") {
          const idx = mediaTarget.blockIdx ?? -1;
          if (idx >= 0 && loc.blocks[idx]) loc.blocks[idx].imageSrc = path;
        }
      } else {
        const srv = next.services.find((s) => s.slug === mediaTarget.slug);
        if (!srv) return next;
        if (mediaTarget.field === "heroImageSrc") {
          srv.heroImageSrc = path;
        } else if (mediaTarget.field === "iconSrc") {
          srv.iconSrc = path;
        } else if (mediaTarget.field === "blockIconSrc") {
          const idx = mediaTarget.blockIdx ?? -1;
          if (idx >= 0 && srv.blocks[idx]) (srv.blocks[idx] as any).iconSrc = path;
        } else {
          const idx = mediaTarget.blockIdx ?? -1;
          if (idx >= 0 && srv.blocks[idx]) srv.blocks[idx].imageSrc = path;
        }
      }
      return next;
    });
    setMediaOpen(false);
  }

  function confirmDelete(kind: "service" | "location", name: string) {
    return window.confirm(`Are you sure to remove the "${kind}" (${name})?`);
  }

  function addLocation() {
    if (!cms) return;
    const slug = `new-location-${Date.now()}`;
    setCms({
      ...cms,
      locations: [
        ...cms.locations,
        {
          slug,
          name: "New Location",
          description: "",
          iconKey: "FaMapMarkerAlt",
          heroImageSrc: "",
          blocks: [],
        },
      ],
    });
  }

  function addService() {
    if (!cms) return;
    const slug = `new-service-${Date.now()}`;
    setCms({
      ...cms,
      services: [
        ...cms.services,
        {
          slug,
          display: true,
          iconSrc: "/uploads/icon-04.svg",
          title: "New Service",
          excerpt: "",
          heroImageSrc: "/uploads/hero.webp",
          blocks: [],
        },
      ],
    });
  }

  if (!cms) {
    return (
      <main className="adminPage">
        <div className="adminTopbar">
          <h2>Admin Dashboard</h2>
          <div className="adminActions">
            {session ? (
              <button className="adminButton" onClick={() => signOut()} disabled={loading}>
                Sign out
              </button>
            ) : (
              <button className="adminButton adminButtonPrimary" onClick={() => signIn("google")} disabled={loading}>
                Sign in with Google
              </button>
            )}
            <button className="adminButton" onClick={load} disabled={loading}>
              {loading ? "Loading..." : "Reload"}
            </button>
          </div>
        </div>
        {status && <p className="adminStatus">{status}</p>}
      </main>
    );
  }

  return (
    <main className="adminPage adminPageWithTopbar">
      <div className="adminFixedTopbar">
        <div className="adminTopbarRow">
          <Link href="/" className="adminBackLink">
            <FiArrowLeft size={18} />
            <span>Back to website</span>
          </Link>
          {session ? (
            <button className="adminButton" onClick={() => signOut()} disabled={loading}>
              Sign out
            </button>
          ) : null}
        </div>

        <div className="adminTopbarRow adminTopbarRowBottom">
          <div className="adminModeSwitch">
            <button
              className={`adminButton ${mode === "locations" ? "adminButtonPrimary" : ""}`}
              onClick={() => setMode("locations")}
              disabled={loading}
            >
              Edit locations
            </button>
            <button
              className={`adminButton ${mode === "services" ? "adminButtonPrimary" : ""}`}
              onClick={() => setMode("services")}
              disabled={loading}
            >
              Edit services
            </button>
          </div>

          <button className="adminButton adminButtonSave" onClick={save} disabled={loading}>
            {loading ? "Saving..." : "Save"}
          </button>
        </div>

        <div className="adminTopbarRow">
          <div className="adminActions">
            <button
              className="adminButton"
              onClick={mode === "locations" ? addLocation : addService}
              disabled={loading}
            >
              {mode === "locations" ? "Add location" : "Add service"}
            </button>
            <button className="adminButton" onClick={load} disabled={loading}>
              {loading ? "Loading..." : "Reload"}
            </button>
          </div>
        </div>
      </div>

      {status && <p className="adminStatus">{status}</p>}
      {popup ? (
        <div
          className="adminPopupOverlay"
          role="dialog"
          aria-modal="true"
          aria-label={popup.title}
          onClick={() => setPopup(null)}
        >
          <div className="adminPopup" onClick={(e) => e.stopPropagation()}>
            <div className="adminPopupHeader">
              <strong>{popup.title}</strong>
              <button className="adminPopupClose" type="button" onClick={() => setPopup(null)} aria-label="Close">
                ✕
              </button>
            </div>
            <div className="adminPopupBody">
              {popup.body}
              {popup.kind === "error" ? (
                <div style={{ marginTop: "var(--space-10)" }}>
                  <a href="mailto:nikodola@gmail.com">nikodola@gmail.com</a>
                </div>
              ) : null}
            </div>
          </div>
        </div>
      ) : null}

      {mode === "locations" ? (
        <section className="adminSection">
          {cms.locations.map((loc, locIdx) => (
            <details key={`loc-${locIdx}`} className="adminCard">
              <summary className="adminCardHeader">
                <div>
                  <h3>{loc.name}</h3>
                  <div style={{ opacity: 0.7, fontSize: 13 }}>/location/{loc.slug}</div>
                </div>
              </summary>

              <div className="adminCardBody">
                <div className="adminSubheading">Hero section</div>
                <div className="adminRow">
                  <div className="adminField">
                    <label>Slug</label>
                    <input
                      value={loc.slug}
                      onChange={(e) =>
                        setCms((prev) => {
                          if (!prev) return prev;
                          const next = deepClone(prev);
                          const target = next.locations.find((l) => l.slug === loc.slug);
                          if (target) target.slug = e.target.value;
                          return next;
                        })
                      }
                      disabled={loading}
                    />
                  </div>
                  <div className="adminField">
                    <label>Name</label>
                    <input
                      value={loc.name}
                      onChange={(e) =>
                        setCms((prev) => {
                          if (!prev) return prev;
                          const next = deepClone(prev);
                          const target = next.locations.find((l) => l.slug === loc.slug);
                          if (target) target.name = e.target.value;
                          return next;
                        })
                      }
                      disabled={loading}
                    />
                  </div>
                </div>

                <div className="adminField">
                  <label>Description</label>
                  <textarea
                    value={loc.description ?? ""}
                    onChange={(e) =>
                      setCms((prev) => {
                        if (!prev) return prev;
                        const next = deepClone(prev);
                        const target = next.locations.find((l) => l.slug === loc.slug);
                        if (target) target.description = e.target.value;
                        return next;
                      })
                    }
                    disabled={loading}
                  />
                </div>

                <div className="adminRow">
                  <div className="adminField">
                    <label>Hero image</label>
                    <div className="blockPreview">
                      {loc.heroImageSrc ? <img src={loc.heroImageSrc} alt="" /> : null}
                      <input
                        type="file"
                        accept="image/*"
                        onChange={async (e) => {
                          const file = e.target.files?.[0];
                          if (!file) return;
                          const path = await uploadFile(file);
                          if (!path) return;
                          setCms((prev) => {
                            if (!prev) return prev;
                            const next = deepClone(prev);
                            const target = next.locations.find((l) => l.slug === loc.slug);
                            if (target) target.heroImageSrc = path;
                            return next;
                          });
                        }}
                        disabled={loading}
                      />
                      <button
                        className="adminButton"
                        type="button"
                        onClick={() => openMediaPicker({ type: "location", slug: loc.slug, field: "heroImageSrc" })}
                        disabled={loading}
                      >
                        Add image from media
                      </button>
                    </div>
                  </div>

                  <div className="adminField">
                    <label>Icon key</label>
                    <select
                      value={loc.iconKey ?? "FaMapMarkerAlt"}
                      onChange={(e) =>
                        setCms((prev) => {
                          if (!prev) return prev;
                          const next = deepClone(prev);
                          const target = next.locations.find((l) => l.slug === loc.slug);
                          if (target) target.iconKey = e.target.value;
                          return next;
                        })
                      }
                      disabled={loading}
                    >
                      <option value="FaBuilding">FaBuilding</option>
                      <option value="FaHome">FaHome</option>
                      <option value="FaWarehouse">FaWarehouse</option>
                      <option value="FaDumbbell">FaDumbbell</option>
                      <option value="FaHospital">FaHospital</option>
                      <option value="FaGraduationCap">FaGraduationCap</option>
                      <option value="FaMapMarkerAlt">FaMapMarkerAlt</option>
                    </select>
                  </div>
                </div>

                <div className="adminField">
                  <label>Blocks</label>
                  <div className="adminActions">
                    <button
                      className="adminButton"
                      onClick={() =>
                        setCms((prev) => {
                          if (!prev) return prev;
                          const next = deepClone(prev);
                          const target = next.locations.find((l) => l.slug === loc.slug);
                          if (!target) return next;
                          target.blocks.push({ layout: "left", eyebrow: "", heading: "New block", body: "", iconSrc: "", imageSrc: "" });
                          return next;
                        })
                      }
                      disabled={loading}
                    >
                      Add block
                    </button>
                  </div>

                  <div className="blocksList">
                    {loc.blocks.map((b, idx) => (
                      <div key={idx} className="blockItem">
                        <div className="adminBlockHeader">Section {idx + 1}</div>
                        <div className="adminRow">
                          <div className="adminField">
                            <label>Layout</label>
                            <select
                              value={b.layout}
                              onChange={(e) =>
                                setCms((prev) => {
                                  if (!prev) return prev;
                                  const next = deepClone(prev);
                                  const target = next.locations.find((l) => l.slug === loc.slug);
                                  if (target) target.blocks[idx].layout = e.target.value as any;
                                  return next;
                                })
                              }
                              disabled={loading}
                            >
                              <option value="left">left</option>
                              <option value="right">right</option>
                              <option value="center">center</option>
                            </select>
                          </div>
                          <div className="adminField">
                            <label>Before headline</label>
                            <input
                              value={b.eyebrow ?? ""}
                              onChange={(e) =>
                                setCms((prev) => {
                                  if (!prev) return prev;
                                  const next = deepClone(prev);
                                  const target = next.locations.find((l) => l.slug === loc.slug);
                                  if (target) target.blocks[idx].eyebrow = e.target.value;
                                  return next;
                                })
                              }
                              disabled={loading}
                            />
                          </div>
                        </div>

                        <div className="adminField">
                          <label>Headline</label>
                          <input
                            value={b.heading}
                            onChange={(e) =>
                              setCms((prev) => {
                                if (!prev) return prev;
                                const next = deepClone(prev);
                                const target = next.locations.find((l) => l.slug === loc.slug);
                                if (target) target.blocks[idx].heading = e.target.value;
                                return next;
                              })
                            }
                            disabled={loading}
                          />
                        </div>

                        <div className="adminField">
                          <label>After headline</label>
                          <textarea
                            value={b.body ?? ""}
                            onChange={(e) =>
                              setCms((prev) => {
                                if (!prev) return prev;
                                const next = deepClone(prev);
                                const target = next.locations.find((l) => l.slug === loc.slug);
                                if (target) target.blocks[idx].body = e.target.value;
                                return next;
                              })
                            }
                            disabled={loading}
                          />
                        </div>

                        <div className="adminField adminFieldSectionIcon">
                          <label>Section icon (optional)</label>
                          <div className="blockPreview">
                            {(b as any).iconSrc ? <img src={(b as any).iconSrc} alt="" /> : null}
                            <input
                              type="file"
                              accept="image/*"
                              onChange={async (e) => {
                                const file = e.target.files?.[0];
                                if (!file) return;
                                const path = await uploadFile(file);
                                if (!path) return;
                                setCms((prev) => {
                                  if (!prev) return prev;
                                  const next = deepClone(prev);
                                  const target = next.locations.find((l) => l.slug === loc.slug);
                                  if (target) (target.blocks[idx] as any).iconSrc = path;
                                  return next;
                                });
                              }}
                              disabled={loading}
                            />
                            <button
                              className="adminButton"
                              type="button"
                              onClick={() =>
                                openMediaPicker({ type: "location", slug: loc.slug, field: "blockIconSrc", blockIdx: idx })
                              }
                              disabled={loading}
                            >
                              Add icon from media
                            </button>
                            <input
                              value={(b as any).iconSrc ?? ""}
                              onChange={(e) =>
                                setCms((prev) => {
                                  if (!prev) return prev;
                                  const next = deepClone(prev);
                                  const target = next.locations.find((l) => l.slug === loc.slug);
                                  if (target) (target.blocks[idx] as any).iconSrc = e.target.value;
                                  return next;
                                })
                              }
                              disabled={loading}
                              placeholder="/uploads/your-icon.png"
                            />
                          </div>
                        </div>

                        <div className="adminField">
                          <label>Image</label>
                          <div className="blockPreview">
                            {b.imageSrc ? <img src={b.imageSrc} alt="" /> : null}
                            <input
                              type="file"
                              accept="image/*"
                              onChange={async (e) => {
                                const file = e.target.files?.[0];
                                if (!file) return;
                                const path = await uploadFile(file);
                                if (!path) return;
                                setCms((prev) => {
                                  if (!prev) return prev;
                                  const next = deepClone(prev);
                                  const target = next.locations.find((l) => l.slug === loc.slug);
                                  if (target) target.blocks[idx].imageSrc = path;
                                  return next;
                                });
                              }}
                              disabled={loading}
                            />
                            <button
                              className="adminButton"
                              type="button"
                              onClick={() => openMediaPicker({ type: "location", slug: loc.slug, field: "imageSrc", blockIdx: idx })}
                              disabled={loading}
                            >
                              Add image from media
                            </button>
                          </div>
                        </div>

                        <button
                          className="adminButton adminButtonDanger"
                          onClick={() =>
                            setCms((prev) => {
                              if (!prev) return prev;
                              const next = deepClone(prev);
                              const target = next.locations.find((l) => l.slug === loc.slug);
                              if (target) target.blocks.splice(idx, 1);
                              return next;
                            })
                          }
                          disabled={loading}
                        >
                          Delete block
                        </button>
                      </div>
                    ))}
                  </div>
                </div>

                <button
                  className="adminButton adminButtonDeleteEntity"
                  onClick={() => {
                    if (!confirmDelete("location", loc.name)) return;
                    setCms((prev) => {
                      if (!prev) return prev;
                      const next = deepClone(prev);
                      next.locations = next.locations.filter((l) => l.slug !== loc.slug);
                      return next;
                    });
                  }}
                  disabled={loading}
                >
                  Delete location
                </button>
              </div>
            </details>
          ))}

          <div className="adminSettingsCard">
            <div style={{ fontWeight: 800 }}>Dynamic pages</div>
            <div style={{ opacity: 0.75, marginTop: 6 }}>
              If disabled, Locations will not appear in the navbar and cards won’t link to /location/[slug].
            </div>
            <div className="adminRadioRow">
              <label className="adminRadio">
                <input
                  type="radio"
                  name="locations-dynamic"
                  checked={cms.dynamicPages.locations === true}
                  onChange={() => setCms((prev) => (prev ? { ...prev, dynamicPages: { ...prev.dynamicPages, locations: true } } : prev))}
                  disabled={loading}
                />
                On
              </label>
              <label className="adminRadio">
                <input
                  type="radio"
                  name="locations-dynamic"
                  checked={cms.dynamicPages.locations === false}
                  onChange={() => setCms((prev) => (prev ? { ...prev, dynamicPages: { ...prev.dynamicPages, locations: false } } : prev))}
                  disabled={loading}
                />
                Off
              </label>
            </div>
          </div>
        </section>
      ) : (
        <section className="adminSection">
          {cms.services.map((srv, srvIdx) => (
            <details key={`srv-${srvIdx}`} className="adminCard">
              <summary className="adminCardHeader">
                <div>
                  <h3>{srv.title}</h3>
                  <div style={{ opacity: 0.7, fontSize: 13 }}>/service/{srv.slug}</div>
                </div>
              </summary>
              <div className="adminCardBody">
                <div className="adminSubheading">Hero section</div>
                <div className="adminRow">
                  <div className="adminField">
                    <label>Slug</label>
                    <input
                      value={srv.slug}
                      onChange={(e) =>
                        setCms((prev) => {
                          if (!prev) return prev;
                          const next = deepClone(prev);
                          const target = next.services.find((s) => s.slug === srv.slug);
                          if (target) target.slug = e.target.value;
                          return next;
                        })
                      }
                      disabled={loading}
                    />
                  </div>
                  <div className="adminField">
                    <label>Title</label>
                    <input
                      value={srv.title}
                      onChange={(e) =>
                        setCms((prev) => {
                          if (!prev) return prev;
                          const next = deepClone(prev);
                          const target = next.services.find((s) => s.slug === srv.slug);
                          if (target) target.title = e.target.value;
                          return next;
                        })
                      }
                      disabled={loading}
                    />
                  </div>
                </div>

                <div className="adminRow">
                  <div className="adminField">
                    <label>Display on homepage</label>
                    <select
                      value={srv.display ? "yes" : "no"}
                      onChange={(e) =>
                        setCms((prev) => {
                          if (!prev) return prev;
                          const next = deepClone(prev);
                          const target = next.services.find((s) => s.slug === srv.slug);
                          if (target) target.display = e.target.value === "yes";
                          return next;
                        })
                      }
                      disabled={loading}
                    >
                      <option value="yes">Yes</option>
                      <option value="no">No</option>
                    </select>
                  </div>
                  <div className="adminField">
                    <label>Icon image</label>
                    <div className="blockPreview">
                      {srv.iconSrc ? <img src={srv.iconSrc} alt="" /> : null}
                      <input
                        type="file"
                        accept="image/*"
                        onChange={async (e) => {
                          const file = e.target.files?.[0];
                          if (!file) return;
                          const path = await uploadFile(file);
                          if (!path) return;
                          setCms((prev) => {
                            if (!prev) return prev;
                            const next = deepClone(prev);
                            const target = next.services.find((s) => s.slug === srv.slug);
                            if (target) target.iconSrc = path;
                            return next;
                          });
                        }}
                        disabled={loading}
                      />
                      <button
                        className="adminButton"
                        type="button"
                        onClick={() => openMediaPicker({ type: "service", slug: srv.slug, field: "iconSrc" })}
                        disabled={loading}
                      >
                        Add icon from media
                      </button>
                      <input
                        value={srv.iconSrc}
                        onChange={(e) =>
                          setCms((prev) => {
                            if (!prev) return prev;
                            const next = deepClone(prev);
                            const target = next.services.find((s) => s.slug === srv.slug);
                            if (target) target.iconSrc = e.target.value;
                            return next;
                          })
                        }
                        disabled={loading}
                      />
                    </div>
                  </div>
                </div>

                <div className="adminField">
                  <label>Excerpt</label>
                  <textarea
                    value={srv.excerpt}
                    onChange={(e) =>
                      setCms((prev) => {
                        if (!prev) return prev;
                        const next = deepClone(prev);
                        const target = next.services.find((s) => s.slug === srv.slug);
                        if (target) target.excerpt = e.target.value;
                        return next;
                      })
                    }
                    disabled={loading}
                  />
                </div>

                <div className="adminField">
                  <label>Hero image</label>
                  <div className="blockPreview">
                    {srv.heroImageSrc ? <img src={srv.heroImageSrc} alt="" /> : null}
                    <input
                      type="file"
                      accept="image/*"
                      onChange={async (e) => {
                        const file = e.target.files?.[0];
                        if (!file) return;
                        const path = await uploadFile(file);
                        if (!path) return;
                        setCms((prev) => {
                          if (!prev) return prev;
                          const next = deepClone(prev);
                          const target = next.services.find((s) => s.slug === srv.slug);
                          if (target) target.heroImageSrc = path;
                          return next;
                        });
                      }}
                      disabled={loading}
                    />
                    <button
                      className="adminButton"
                      type="button"
                      onClick={() => openMediaPicker({ type: "service", slug: srv.slug, field: "heroImageSrc" })}
                      disabled={loading}
                    >
                      Add image from media
                    </button>
                  </div>
                </div>

                <div className="adminField">
                  <label>Blocks</label>
                  <div className="adminActions">
                    <button
                      className="adminButton"
                      onClick={() =>
                        setCms((prev) => {
                          if (!prev) return prev;
                          const next = deepClone(prev);
                          const target = next.services.find((s) => s.slug === srv.slug);
                          if (!target) return next;
                          target.blocks.push({ layout: "left", eyebrow: "", heading: "New block", body: "", iconSrc: "", imageSrc: "" });
                          return next;
                        })
                      }
                      disabled={loading}
                    >
                      Add block
                    </button>
                  </div>

                  <div className="blocksList">
                    {srv.blocks.map((b, idx) => (
                      <div key={idx} className="blockItem">
                        <div className="adminBlockHeader">Section {idx + 1}</div>
                        <div className="adminRow">
                          <div className="adminField">
                            <label>Layout</label>
                            <select
                              value={b.layout}
                              onChange={(e) =>
                                setCms((prev) => {
                                  if (!prev) return prev;
                                  const next = deepClone(prev);
                                  const target = next.services.find((s) => s.slug === srv.slug);
                                  if (target) target.blocks[idx].layout = e.target.value as any;
                                  return next;
                                })
                              }
                              disabled={loading}
                            >
                              <option value="left">left</option>
                              <option value="right">right</option>
                              <option value="center">center</option>
                            </select>
                          </div>
                          <div className="adminField">
                            <label>Before headline</label>
                            <input
                              value={b.eyebrow ?? ""}
                              onChange={(e) =>
                                setCms((prev) => {
                                  if (!prev) return prev;
                                  const next = deepClone(prev);
                                  const target = next.services.find((s) => s.slug === srv.slug);
                                  if (target) target.blocks[idx].eyebrow = e.target.value;
                                  return next;
                                })
                              }
                              disabled={loading}
                            />
                          </div>
                        </div>

                        <div className="adminField">
                          <label>Headline</label>
                          <input
                            value={b.heading}
                            onChange={(e) =>
                              setCms((prev) => {
                                if (!prev) return prev;
                                const next = deepClone(prev);
                                const target = next.services.find((s) => s.slug === srv.slug);
                                if (target) target.blocks[idx].heading = e.target.value;
                                return next;
                              })
                            }
                            disabled={loading}
                          />
                        </div>

                        <div className="adminField">
                          <label>After headline</label>
                          <textarea
                            value={b.body ?? ""}
                            onChange={(e) =>
                              setCms((prev) => {
                                if (!prev) return prev;
                                const next = deepClone(prev);
                                const target = next.services.find((s) => s.slug === srv.slug);
                                if (target) target.blocks[idx].body = e.target.value;
                                return next;
                              })
                            }
                            disabled={loading}
                          />
                        </div>

                        <div className="adminField adminFieldSectionIcon">
                          <label>Section icon (optional)</label>
                          <div className="blockPreview">
                            {(b as any).iconSrc ? <img src={(b as any).iconSrc} alt="" /> : null}
                            <input
                              type="file"
                              accept="image/*"
                              onChange={async (e) => {
                                const file = e.target.files?.[0];
                                if (!file) return;
                                const path = await uploadFile(file);
                                if (!path) return;
                                setCms((prev) => {
                                  if (!prev) return prev;
                                  const next = deepClone(prev);
                                  const target = next.services.find((s) => s.slug === srv.slug);
                                  if (target) (target.blocks[idx] as any).iconSrc = path;
                                  return next;
                                });
                              }}
                              disabled={loading}
                            />
                            <button
                              className="adminButton"
                              type="button"
                              onClick={() =>
                                openMediaPicker({ type: "service", slug: srv.slug, field: "blockIconSrc", blockIdx: idx })
                              }
                              disabled={loading}
                            >
                              Add icon from media
                            </button>
                            <input
                              value={(b as any).iconSrc ?? ""}
                              onChange={(e) =>
                                setCms((prev) => {
                                  if (!prev) return prev;
                                  const next = deepClone(prev);
                                  const target = next.services.find((s) => s.slug === srv.slug);
                                  if (target) (target.blocks[idx] as any).iconSrc = e.target.value;
                                  return next;
                                })
                              }
                              disabled={loading}
                              placeholder="/uploads/your-icon.png"
                            />
                          </div>
                        </div>

                        <div className="adminField">
                          <label>Image</label>
                          <div className="blockPreview">
                            {b.imageSrc ? <img src={b.imageSrc} alt="" /> : null}
                            <input
                              type="file"
                              accept="image/*"
                              onChange={async (e) => {
                                const file = e.target.files?.[0];
                                if (!file) return;
                                const path = await uploadFile(file);
                                if (!path) return;
                                setCms((prev) => {
                                  if (!prev) return prev;
                                  const next = deepClone(prev);
                                  const target = next.services.find((s) => s.slug === srv.slug);
                                  if (target) target.blocks[idx].imageSrc = path;
                                  return next;
                                });
                              }}
                              disabled={loading}
                            />
                            <button
                              className="adminButton"
                              type="button"
                              onClick={() => openMediaPicker({ type: "service", slug: srv.slug, field: "imageSrc", blockIdx: idx })}
                              disabled={loading}
                            >
                              Add image from media
                            </button>
                          </div>
                        </div>

                        <button
                          className="adminButton adminButtonDanger"
                          onClick={() =>
                            setCms((prev) => {
                              if (!prev) return prev;
                              const next = deepClone(prev);
                              const target = next.services.find((s) => s.slug === srv.slug);
                              if (target) target.blocks.splice(idx, 1);
                              return next;
                            })
                          }
                          disabled={loading}
                        >
                          Delete block
                        </button>
                      </div>
                    ))}
                  </div>
                </div>

                <button
                  className="adminButton adminButtonDeleteEntity"
                  onClick={() => {
                    if (!confirmDelete("service", srv.title)) return;
                    setCms((prev) => {
                      if (!prev) return prev;
                      const next = deepClone(prev);
                      next.services = next.services.filter((s) => s.slug !== srv.slug);
                      return next;
                    });
                  }}
                  disabled={loading}
                >
                  Delete service
                </button>
              </div>
            </details>
          ))}

          <div className="adminSettingsCard">
            <div style={{ fontWeight: 800 }}>Dynamic pages</div>
            <div style={{ opacity: 0.75, marginTop: 6 }}>
              If disabled, Services will not appear in the navbar and cards won’t link to /service/[slug].
            </div>
            <div className="adminRadioRow">
              <label className="adminRadio">
                <input
                  type="radio"
                  name="services-dynamic"
                  checked={cms.dynamicPages.services === true}
                  onChange={() => setCms((prev) => (prev ? { ...prev, dynamicPages: { ...prev.dynamicPages, services: true } } : prev))}
                  disabled={loading}
                />
                On
              </label>
              <label className="adminRadio">
                <input
                  type="radio"
                  name="services-dynamic"
                  checked={cms.dynamicPages.services === false}
                  onChange={() => setCms((prev) => (prev ? { ...prev, dynamicPages: { ...prev.dynamicPages, services: false } } : prev))}
                  disabled={loading}
                />
                Off
              </label>
            </div>
          </div>
        </section>
      )}

      {mediaOpen ? (
        <div className="adminModalOverlay" role="dialog" aria-modal="true">
          <div className="adminModal">
            <div className="adminModalHeader">
              <h3>Media</h3>
              <button className="adminButton" onClick={() => setMediaOpen(false)} disabled={loading}>
                Close
              </button>
            </div>
            <div className="adminMediaGrid">
              {media.map((p) => (
                <button key={p} className="adminMediaItem" onClick={() => setImageFromPicker(p)}>
                  <img src={p} alt={p} />
                  <div className="adminMediaLabel">{p}</div>
                </button>
              ))}
            </div>
          </div>
        </div>
      ) : null}
    </main>
  );
}

